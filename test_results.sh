#!/bin/bash

# Source this file to aggregate correlation results of the simulations for test_analysis.ipynb
# Important: need to already have hardware results in ./hw_run
# (currently PWD needs to be accel-sim-framework)
# Need to provide parameters like below

# Example:
# source test_results.sh util/tuner/RTX2080_S/dlt cuDGT test0

source_dir="$1"     # Directory of expanded & indexed configs generated by apply_parsed_deltas() from test_configs.ipynb
benchmark="$2"      # Name of the benchmark (defined in util/job_launching/apps/define-all-apps.yml)
prefix="$3"         # Custom prefix appended in test_run.sh

for filename in "$source_dir"/*.config; do
  id=${filename%.config}
  echo "Getting results of ${id##*/}"
  ./util/job_launching/get_stats.py -R -k -K -N "$prefix-$benchmark-${id##*/}" | tee per.kernel.stats.csv
  ./util/plotting/plot-correlation.py -c per.kernel.stats.csv -H ./hw_run/device-0/11.6/ -O "$prefix-$benchmark/${id##*/}"
done